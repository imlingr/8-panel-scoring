
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>113職業訪談-自評＆互評表</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #ffffff; /* 背景改為白色 */
        }
        .form-container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .progress-bar {
            height: 8px;
            background-color: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
        }
        .progress {
            height: 100%;
            background-color: #4f46e5;
            transition: width 0.3s ease;
        }
        .option-card {
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        .option-card:hover {
            border-color: #a5b4fc;
            background-color: #f5f7ff;
        }
        .option-card.selected {
            border-color: #4f46e5;
            background-color: #eef2ff;
        }
        .option-card.evaluated {
            border-color: #10b981;
            background-color: #ecfdf5;
        }
        .btn-primary {
            background-color: #4f46e5;
            color: white;
            transition: all 0.2s ease;
        }
        .btn-primary:hover {
            background-color: #4338ca;
        }
        .btn-secondary {
            background-color: #e2e8f0;
            color: #4b5563;
            transition: all 0.2s ease;
        }
        .btn-secondary:hover {
            background-color: #cbd5e1;
        }
        .rating-container {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
        }
        .rating-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background-color: #f3f4f6;
            border: 2px solid #e5e7eb;
        }
        .rating-btn:hover {
            background-color: #e5edff;
            border-color: #a5b4fc;
        }
        .rating-btn.selected {
            background-color: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }
        .custom-checkbox {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .custom-checkbox:hover {
            background-color: #f5f7ff;
        }
        .custom-checkbox.selected {
            background-color: #eef2ff;
        }
        .custom-checkbox input {
            margin-right: 10px;
        }
        .class-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
        }
        .class-icon {
            width: 80px;
            height: 80px;
            margin-bottom: 12px;
        }
        .header-logo {
            max-width: 100%;
            height: auto;
            margin-bottom: 20px;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #4f46e5;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="py-8 px-4">
    <div class="form-container p-6 md:p-8">
        <!-- 表單頂部圖片 - 已更新 -->
        <div class="text-center mb-6">
            <img src="https://lh3.googleusercontent.com/pw/AP1GczNXDp3p02uknh_-hoyMzneujGrAXG210XUd_rkskHpWdXauH3OJ8jK_14rEwYzcG5h8u3J_X2FBTgVdhDcO4tdJe_BbDE7uFLgGeQIAN2lvsKx4lMaYjSPfSf1jR3Sam6gVROPTq9Afd10tIWMlW86l=w1920-h480-s-no-gm?authuser=0" alt="表單頂部圖片" class="header-logo mx-auto">
        </div>
        
        <h1 class="text-2xl md:text-3xl font-bold text-center mb-6 text-indigo-700">113職業訪談-自評＆互評表</h1>
        
        <div class="mb-6">
            <div class="progress-bar">
                <div class="progress" id="progressBar" style="width: 0%"></div>
            </div>
            <div class="flex justify-between mt-2 text-sm text-gray-500">
                <span>開始</span>
                <span>班級/組別</span>
                <span>自評</span>
                <span>互評</span>
                <span>完成</span>
            </div>
        </div>

        <!-- 表單區域 -->
        <div id="formContainer">
            <!-- 班級選擇頁面 - 已更新圖標和布局 -->
            <div id="classSelection" class="form-page">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <span class="bg-indigo-600 text-white rounded-full w-7 h-7 flex items-center justify-center mr-2">1</span>
                    請選擇您的班級
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div class="option-card class-card cursor-pointer" data-value="809" onclick="selectClass(this)">
                        <img src="https://cdn-icons-png.flaticon.com/128/13562/13562989.png" alt="809班" class="class-icon">
                        <span class="font-medium">809班</span>
                    </div>
                    <div class="option-card class-card cursor-pointer" data-value="818" onclick="selectClass(this)">
                        <img src="https://cdn-icons-png.flaticon.com/128/13562/13562979.png" alt="818班" class="class-icon">
                        <span class="font-medium">818班</span>
                    </div>
                </div>
                <div class="flex justify-end">
                    <button id="nextToGroup" class="btn-primary px-6 py-2 rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        下一步
                    </button>
                </div>
            </div>

            <!-- 組別選擇頁面 -->
            <div id="groupSelection" class="form-page hidden">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <span class="bg-indigo-600 text-white rounded-full w-7 h-7 flex items-center justify-center mr-2">2</span>
                    請選擇您的組別
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6" id="groupOptions">
                    <!-- 組別選項將由JavaScript動態生成 -->
                </div>
                <div class="flex justify-between">
                    <button class="btn-secondary px-6 py-2 rounded-lg font-medium" onclick="prevPage('classSelection')">
                        上一步
                    </button>
                    <button id="nextToSelfEval" class="btn-primary px-6 py-2 rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        下一步
                    </button>
                </div>
            </div>

            <!-- 自評-選擇自己頁面 -->
            <div id="selfSelection" class="form-page hidden">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <span class="bg-indigo-600 text-white rounded-full w-7 h-7 flex items-center justify-center mr-2">3</span>
                    請選擇您是哪一位組員
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6" id="memberOptions">
                    <!-- 組員選項將由JavaScript動態生成 -->
                </div>
                <div class="flex justify-between">
                    <button class="btn-secondary px-6 py-2 rounded-lg font-medium" onclick="prevPage('groupSelection')">
                        上一步
                    </button>
                    <button id="nextToSelfTasks" class="btn-primary px-6 py-2 rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        下一步
                    </button>
                </div>
            </div>

            <!-- 自評-工作任務頁面 -->
            <div id="selfTasks" class="form-page hidden">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <span class="bg-indigo-600 text-white rounded-full w-7 h-7 flex items-center justify-center mr-2">4</span>
                    您在這次職業訪談中負責的工作任務是？（可複選）
                </h2>
                <div class="mb-6" id="taskCheckboxes">
                    <div class="custom-checkbox" onclick="toggleCheckbox(this)">
                        <input type="checkbox" id="task1" name="selfTasks" value="當天參與訪談">
                        <label for="task1">📅 當天參與訪談</label>
                    </div>
                    <div class="custom-checkbox" onclick="toggleCheckbox(this)">
                        <input type="checkbox" id="task2" name="selfTasks" value="接洽受談者">
                        <label for="task2">🤝 接洽受談者</label>
                    </div>
                    <div class="custom-checkbox" onclick="toggleCheckbox(this)">
                        <input type="checkbox" id="task3" name="selfTasks" value="查資料">
                        <label for="task3">🔍 查資料</label>
                    </div>
                    <div class="custom-checkbox" onclick="toggleCheckbox(this)">
                        <input type="checkbox" id="task4" name="selfTasks" value="設計問題">
                        <label for="task4">❓ 設計問題</label>
                    </div>
                    <div class="custom-checkbox" onclick="toggleCheckbox(this)">
                        <input type="checkbox" id="task5" name="selfTasks" value="小記者訪問">
                        <label for="task5">🎤 小記者訪問</label>
                    </div>
                    <div class="custom-checkbox" onclick="toggleCheckbox(this)">
                        <input type="checkbox" id="task6" name="selfTasks" value="拍照">
                        <label for="task6">📸 拍照</label>
                    </div>
                    <div class="custom-checkbox" onclick="toggleCheckbox(this)">
                        <input type="checkbox" id="task7" name="selfTasks" value="記錄">
                        <label for="task7">📝 記錄</label>
                    </div>
                    <div class="custom-checkbox" onclick="toggleCheckbox(this)">
                        <input type="checkbox" id="task8" name="selfTasks" value="做簡報">
                        <label for="task8">💻 做簡報</label>
                    </div>
                    <div class="custom-checkbox" onclick="toggleCheckbox(this)">
                        <input type="checkbox" id="task9" name="selfTasks" value="上台報告">
                        <label for="task9">🎭 上台報告</label>
                    </div>
                    <div class="custom-checkbox" onclick="toggleCheckbox(this)">
                        <input type="checkbox" id="task10" name="selfTasks" value="編劇">
                        <label for="task10">✍️ 編劇</label>
                    </div>
                    <div class="custom-checkbox" onclick="toggleCheckbox(this)">
                        <input type="checkbox" id="task11" name="selfTasks" value="表演">
                        <label for="task11">🎬 表演</label>
                    </div>
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">其他工作任務（選填）</label>
                        <input type="text" id="otherSelfTask" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="請輸入其他工作任務">
                    </div>
                </div>
                <div class="flex justify-between">
                    <button class="btn-secondary px-6 py-2 rounded-lg font-medium" onclick="prevPage('selfSelection')">
                        上一步
                    </button>
                    <button id="nextToSelfEffort" class="btn-primary px-6 py-2 rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed">
                        下一步
                    </button>
                </div>
            </div>

            <!-- 自評-投入程度頁面 -->
            <div id="selfEffort" class="form-page hidden">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <span class="bg-indigo-600 text-white rounded-full w-7 h-7 flex items-center justify-center mr-2">5</span>
                    您認為自己的投入認真協助程度如何？（可複選）
                </h2>
                <div class="mb-6" id="effortCheckboxes">
                    <div class="custom-checkbox" onclick="toggleCheckbox(this)">
                        <input type="checkbox" id="effort1" name="selfEffort" value="A我幾乎什麼都沒有做🙃">
                        <label for="effort1">A我幾乎什麼都沒有做🙃</label>
                    </div>
                    <div class="custom-checkbox" onclick="toggleCheckbox(this)">
                        <input type="checkbox" id="effort2" name="selfEffort" value="B我只做了自己的工作，而且還沒做完😣">
                        <label for="effort2">B我只做了自己的工作，而且還沒做完😣</label>
                    </div>
                    <div class="custom-checkbox" onclick="toggleCheckbox(this)">
                        <input type="checkbox" id="effort3" name="selfEffort" value="C我只完成自己的工作，坦白說有點隨便😅">
                        <label for="effort3">C我只完成自己的工作，坦白說有點隨便😅</label>
                    </div>
                    <div class="custom-checkbox" onclick="toggleCheckbox(this)">
                        <input type="checkbox" id="effort4" name="selfEffort" value="D我只完成了自己的工作，而且我還遲交😔">
                        <label for="effort4">D我只完成了自己的工作，而且我還遲交😔</label>
                    </div>
                    <div class="custom-checkbox" onclick="toggleCheckbox(this)">
                        <input type="checkbox" id="effort5" name="selfEffort" value="E我只完成了自己的工作，我盡力了，但成果好像普通而已🤔">
                        <label for="effort5">E我只完成了自己的工作，我盡力了，但成果好像普通而已🤔</label>
                    </div>
                    <div class="custom-checkbox" onclick="toggleCheckbox(this)">
                        <input type="checkbox" id="effort6" name="selfEffort" value="F我只完成了自己的工作，但我有認真做🫡">
                        <label for="effort6">F我只完成了自己的工作，但我有認真做🫡</label>
                    </div>
                    <div class="custom-checkbox" onclick="toggleCheckbox(this)">
                        <input type="checkbox" id="effort7" name="selfEffort" value="G我只完成了自己的工作，但我花費了很多時間和心力，我很認真🙂">
                        <label for="effort7">G我只完成了自己的工作，但我花費了很多時間和心力，我很認真🙂</label>
                    </div>
                    <div class="custom-checkbox" onclick="toggleCheckbox(this)">
                        <input type="checkbox" id="effort8" name="selfEffort" value="H我不只完成了自己的工作，我還會關心提醒其他的組員進度😊">
                        <label for="effort8">H我不只完成了自己的工作，我還會關心提醒其他的組員進度😊</label>
                    </div>
                    <div class="custom-checkbox" onclick="toggleCheckbox(this)">
                        <input type="checkbox" id="effort9" name="selfEffort" value="I 我不只完成自己的任務，我後來還幫忙其他人一起做，花了超多時間及心力😃">
                        <label for="effort9">I 我不只完成自己的任務，我後來還幫忙其他人一起做，花了超多時間及心力😃</label>
                    </div>
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">其他投入程度描述（選填）</label>
                        <input type="text" id="otherSelfEffort" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="請輸入其他投入程度描述">
                    </div>
                </div>
                <div class="flex justify-between">
                    <button class="btn-secondary px-6 py-2 rounded-lg font-medium" onclick="prevPage('selfTasks')">
                        上一步
                    </button>
                    <button id="nextToSelfRating" class="btn-primary px-6 py-2 rounded-lg font-medium">
                        下一步
                    </button>
                </div>
            </div>

            <!-- 自評-評分頁面 -->
            <div id="selfRating" class="form-page hidden">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <span class="bg-indigo-600 text-white rounded-full w-7 h-7 flex items-center justify-center mr-2">6</span>
                    請為自己的表現評分（1-10分）
                </h2>
                <div class="mb-6">
                    <div class="rating-container">
                        <div class="rating-btn" data-value="1" onclick="selectRating(this, 'selfRatingValue')">1</div>
                        <div class="rating-btn" data-value="2" onclick="selectRating(this, 'selfRatingValue')">2</div>
                        <div class="rating-btn" data-value="3" onclick="selectRating(this, 'selfRatingValue')">3</div>
                        <div class="rating-btn" data-value="4" onclick="selectRating(this, 'selfRatingValue')">4</div>
                        <div class="rating-btn" data-value="5" onclick="selectRating(this, 'selfRatingValue')">5</div>
                        <div class="rating-btn" data-value="6" onclick="selectRating(this, 'selfRatingValue')">6</div>
                        <div class="rating-btn" data-value="7" onclick="selectRating(this, 'selfRatingValue')">7</div>
                        <div class="rating-btn" data-value="8" onclick="selectRating(this, 'selfRatingValue')">8</div>
                        <div class="rating-btn" data-value="9" onclick="selectRating(this, 'selfRatingValue')">9</div>
                        <div class="rating-btn" data-value="10" onclick="selectRating(this, 'selfRatingValue')">10</div>
                    </div>
                    <input type="hidden" id="selfRatingValue" value="">
                    <div class="text-center text-sm text-gray-500 mt-2">
                        <span class="float-left">較差</span>
                        <span class="float-right">優秀</span>
                    </div>
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">整體來說，我覺得在這次職業訪談中，我的表現如何？我可以在什麼地方更進步？</label>
                    <textarea id="selfComment" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" rows="4" placeholder="請輸入您的自我評價..."></textarea>
                </div>
                <div class="flex justify-between">
                    <button class="btn-secondary px-6 py-2 rounded-lg font-medium" onclick="prevPage('selfEffort')">
                        上一步
                    </button>
                    <button id="nextToPeerEval" class="btn-primary px-6 py-2 rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        下一步
                    </button>
                </div>
            </div>

            <!-- 互評-選擇組員頁面 -->
            <div id="peerSelection" class="form-page hidden">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <span class="bg-indigo-600 text-white rounded-full w-7 h-7 flex items-center justify-center mr-2">7</span>
                    請選擇您要評價的組員 (<span id="peerEvalCount">0</span>/4)
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6" id="peerOptions">
                    <!-- 組員選項將由JavaScript動態生成 -->
                </div>
                <div class="flex justify-between">
                    <button class="btn-secondary px-6 py-2 rounded-lg font-medium" onclick="prevPage('selfRating')">
                        上一步
                    </button>
                    <button id="nextToPeerTasks" class="btn-primary px-6 py-2 rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        下一步
                    </button>
                </div>
            </div>

            <!-- 互評-工作任務頁面 -->
            <div id="peerTasks" class="form-page hidden">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <span class="bg-indigo-600 text-white rounded-full w-7 h-7 flex items-center justify-center mr-2">8</span>
                    就您所知，<span id="currentPeerName" class="text-indigo-600 font-bold"></span>實際上做了哪些工作任務？（可複選）
                </h2>
                <div class="mb-6" id="peerTaskCheckboxes">
                    <div class="custom-checkbox" onclick="toggleCheckbox(this)">
                        <input type="checkbox" id="peerTask1" name="peerTasks" value="當天參與訪談">
                        <label for="peerTask1">📅 當天參與訪談</label>
                    </div>
                    <div class="custom-checkbox" onclick="toggleCheckbox(this)">
                        <input type="checkbox" id="peerTask2" name="peerTasks" value="接洽受談者">
                        <label for="peerTask2">🤝 接洽受談者</label>
                    </div>
                    <div class="custom-checkbox" onclick="toggleCheckbox(this)">
                        <input type="checkbox" id="peerTask3" name="peerTasks" value="查資料">
                        <label for="peerTask3">🔍 查資料</label>
                    </div>
                    <div class="custom-checkbox" onclick="toggleCheckbox(this)">
                        <input type="checkbox" id="peerTask4" name="peerTasks" value="設計問題">
                        <label for="peerTask4">❓ 設計問題</label>
                    </div>
                    <div class="custom-checkbox" onclick="toggleCheckbox(this)">
                        <input type="checkbox" id="peerTask5" name="peerTasks" value="小記者訪問">
                        <label for="peerTask5">🎤 小記者訪問</label>
                    </div>
                    <div class="custom-checkbox" onclick="toggleCheckbox(this)">
                        <input type="checkbox" id="peerTask6" name="peerTasks" value="拍照">
                        <label for="peerTask6">📸 拍照</label>
                    </div>
                    <div class="custom-checkbox" onclick="toggleCheckbox(this)">
                        <input type="checkbox" id="peerTask7" name="peerTasks" value="記錄">
                        <label for="peerTask7">📝 記錄</label>
                    </div>
                    <div class="custom-checkbox" onclick="toggleCheckbox(this)">
                        <input type="checkbox" id="peerTask8" name="peerTasks" value="做簡報">
                        <label for="peerTask8">💻 做簡報</label>
                    </div>
                    <div class="custom-checkbox" onclick="toggleCheckbox(this)">
                        <input type="checkbox" id="peerTask9" name="peerTasks" value="上台報告">
                        <label for="peerTask9">🎭 上台報告</label>
                    </div>
                    <div class="custom-checkbox" onclick="toggleCheckbox(this)">
                        <input type="checkbox" id="peerTask10" name="peerTasks" value="編劇">
                        <label for="peerTask10">✍️ 編劇</label>
                    </div>
                    <div class="custom-checkbox" onclick="toggleCheckbox(this)">
                        <input type="checkbox" id="peerTask11" name="peerTasks" value="表演">
                        <label for="peerTask11">🎬 表演</label>
                    </div>
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">其他工作任務（選填）</label>
                        <input type="text" id="otherPeerTask" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="請輸入其他工作任務">
                    </div>
                </div>
                <div class="flex justify-between">
                    <button class="btn-secondary px-6 py-2 rounded-lg font-medium" onclick="prevPage('peerSelection')">
                        上一步
                    </button>
                    <button id="nextToPeerRating" class="btn-primary px-6 py-2 rounded-lg font-medium">
                        下一步
                    </button>
                </div>
            </div>

            <!-- 互評-評分頁面 -->
            <div id="peerRating" class="form-page hidden">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <span class="bg-indigo-600 text-white rounded-full w-7 h-7 flex items-center justify-center mr-2">9</span>
                    請為 <span id="currentPeerNameRating" class="text-indigo-600 font-bold"></span> 的表現評分（1-10分）
                </h2>
                <div class="mb-6">
                    <div class="rating-container">
                        <div class="rating-btn" data-value="1" onclick="selectRating(this, 'peerRatingValue')">1</div>
                        <div class="rating-btn" data-value="2" onclick="selectRating(this, 'peerRatingValue')">2</div>
                        <div class="rating-btn" data-value="3" onclick="selectRating(this, 'peerRatingValue')">3</div>
                        <div class="rating-btn" data-value="4" onclick="selectRating(this, 'peerRatingValue')">4</div>
                        <div class="rating-btn" data-value="5" onclick="selectRating(this, 'peerRatingValue')">5</div>
                        <div class="rating-btn" data-value="6" onclick="selectRating(this, 'peerRatingValue')">6</div>
                        <div class="rating-btn" data-value="7" onclick="selectRating(this, 'peerRatingValue')">7</div>
                        <div class="rating-btn" data-value="8" onclick="selectRating(this, 'peerRatingValue')">8</div>
                        <div class="rating-btn" data-value="9" onclick="selectRating(this, 'peerRatingValue')">9</div>
                        <div class="rating-btn" data-value="10" onclick="selectRating(this, 'peerRatingValue')">10</div>
                    </div>
                    <input type="hidden" id="peerRatingValue" value="">
                    <div class="text-center text-sm text-gray-500 mt-2">
                        <span class="float-left">較差</span>
                        <span class="float-right">優秀</span>
                    </div>
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">您給他/她這個分數的具體理由</label>
                    <textarea id="peerComment" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" rows="4" placeholder="請輸入您的評價理由..."></textarea>
                </div>
                <div class="flex justify-between">
                    <button class="btn-secondary px-6 py-2 rounded-lg font-medium" onclick="prevPage('peerTasks')">
                        上一步
                    </button>
                    <button id="nextPeerEval" class="btn-primary px-6 py-2 rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        下一步
                    </button>
                </div>
            </div>

            <!-- 確認頁面 -->
            <div id="confirmation" class="form-page hidden">
                <div class="bg-green-50 border-l-4 border-green-400 p-4 mb-6">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-green-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-green-700">
                                您已完成所有評價！感謝您的參與。
                            </p>
                        </div>
                    </div>
                </div>

                <h2 class="text-xl font-semibold mb-4">評價摘要</h2>
                
                <div class="mb-6">
                    <h3 class="font-medium text-gray-700 mb-2">基本資料</h3>
                    <div class="bg-gray-50 p-4 rounded-lg mb-4">
                        <p><span class="font-medium">班級：</span><span id="summaryClass"></span></p>
                        <p class="mt-1"><span class="font-medium">組別：</span><span id="summaryGroup"></span></p>
                        <p class="mt-1"><span class="font-medium">姓名：</span><span id="summarySelf"></span></p>
                    </div>
                    
                    <h3 class="font-medium text-gray-700 mb-2">自評</h3>
                    <div class="bg-gray-50 p-4 rounded-lg mb-4">
                        <p><span class="font-medium">工作任務：</span><span id="summarySelfTasks"></span></p>
                        <p class="mt-1"><span class="font-medium">其他工作任務：</span><span id="summaryOtherSelfTask"></span></p>
                        <p class="mt-1"><span class="font-medium">投入程度：</span><span id="summarySelfEffort"></span></p>
                        <p class="mt-1"><span class="font-medium">其他投入程度描述：</span><span id="summaryOtherSelfEffort"></span></p>
                        <p class="mt-1"><span class="font-medium">自評分數：</span><span id="summarySelfRating"></span></p>
                        <p class="mt-1"><span class="font-medium">自我評價：</span></p>
                        <p id="summarySelfComment" class="text-gray-600 mt-1"></p>
                    </div>
                </div>

                <div class="mb-6">
                    <h3 class="font-medium text-gray-700 mb-2">互評</h3>
                    <div id="peerEvalSummary" class="space-y-4">
                        <!-- 互評摘要將由JavaScript動態生成 -->
                    </div>
                </div>

                <div class="flex justify-between">
                    <button class="btn-secondary px-6 py-2 rounded-lg font-medium" onclick="returnToStart()">
                        返回修正
                    </button>
                    <button id="submitForm" class="btn-primary px-6 py-2 rounded-lg font-medium">
                        提交評價
                    </button>
                </div>
            </div>

            <!-- 提交成功頁面 -->
            <div id="success" class="form-page hidden">
                <div class="text-center py-10">
                    <svg class="mx-auto h-20 w-20 text-green-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <h2 class="mt-4 text-2xl font-bold text-gray-900">提交成功！</h2>
                    <p class="mt-2 text-gray-600">感謝您完成自評與互評表單。</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 載入中遮罩 -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="spinner"></div>
        <p class="text-gray-700 font-medium">提交中，請稍候...</p>
    </div>

    <script>
    // 班級和組別資料
    const classGroups = {
        '809': [
            { group: '第1組', members: ['04林藤諺', '12謝秉玹', '15邱雅涵', '21陳冠瑜', '24黃星瑜'] },
            { group: '第2組', members: ['03林駿成', '09黃珺', '17張郁婍', '22童于芳', '25黃渝甄'] },
            { group: '第3組', members: ['01王泉象', '12謝秉玹', '08曾唯祐', '14林芊樂', '19張學暄'] },
            { group: '第4組', members: ['06張恩瑞', '10劉修齊', '16洪舒芸', '20陳昀彤', '23黃采潔'] },
            { group: '第5組', members: ['02李昊叡', '07曹煜承', '11劉秩綸', '18張宸語', '26謝旻珊'] }
        ],
        '818': [
            { group: '第1組', members: ['08陳奕崴', '11蔡能筌', '12蕭安祐', '21劉予謙', '27向文文'] },
            { group: '第2組', members: ['02李和樂', '03李哲廷', '09歐祐綸', '17林可惟', '26羅培芯'] },
            { group: '第3組', members: ['04林品佑', '11蔡能筌', '22蔡璦忻', '23蕭安妍', '25藍心言'] },
            { group: '第4組', members: ['06洪晨耀', '13薛牧宸', '14龐仕杰', '15王婧芸', '18孫菉葉'] },
            { group: '第5組', members: ['01王家薰', '07張嘉宏', '16李之瀠', '20陳子姸', '24蕭安妮'] }
        ]
    };

    // 表單資料儲存
    let formData = {
        class: '', group: '', self: '',
        selfTasks: [], otherSelfTask: '',
        selfEffort: [], otherSelfEffort: '',
        selfRating: '', selfComment: '',
        peerEvals: [], // 每個元素格式: { peer: '姓名', tasks: [], otherTask: '', rating: '', comment: '' }
        timestamp: ''
    };

    // 當前互評相關
    let peersToEvaluate = []; // 當前選擇組別後，需要評價的組員列表 (排除自己)
    let currentEvaluatingPeerName = ''; // 當前正在評價的組員姓名
    let formSubmitted = false;

    // 頁面切換函數
    function showPage(pageId) {
        document.querySelectorAll('.form-page').forEach(page => {
            page.classList.add('hidden');
        });
        const targetPage = document.getElementById(pageId);
        if (targetPage) {
            targetPage.classList.remove('hidden');
        }
        updateProgressBar(pageId);
    }

    function prevPage(pageId) {
        showPage(pageId);
    }

    function updateProgressBar(pageId) {
        const progressMap = {
            'classSelection': 0, 'groupSelection': 20, 'selfSelection': 20,
            'selfTasks': 40, 'selfEffort': 40, 'selfRating': 40,
            'peerSelection': 60, 'peerTasks': 80, 'peerRating': 80,
            'confirmation': 100, 'success': 100
        };
        let progress = progressMap[pageId] !== undefined ? progressMap[pageId] : 0;

        if (pageId.startsWith('peer') && peersToEvaluate.length > 0) {
            const evaluatedCount = formData.peerEvals.filter(p => p.rating && p.comment).length;
            let currentPeerOrder = formData.peerEvals.findIndex(p => p.peer === currentEvaluatingPeerName);
             if (currentPeerOrder === -1 && formData.peerEvals.length < peersToEvaluate.length) currentPeerOrder = formData.peerEvals.length;
             else if (currentPeerOrder === -1) currentPeerOrder = Math.max(0, peersToEvaluate.length -1) ;


            if (pageId === 'peerSelection') {
                progress = 60 + (evaluatedCount / peersToEvaluate.length) * 20;
            } else if (pageId === 'peerTasks') {
                progress = 60 + (currentPeerOrder / peersToEvaluate.length) * 20 + (1 / peersToEvaluate.length) * 10;
            } else if (pageId === 'peerRating') {
                progress = 60 + (currentPeerOrder / peersToEvaluate.length) * 20 + (1 / peersToEvaluate.length) * 20;
            }
        }
        const progressBarElement = document.getElementById('progressBar');
        if (progressBarElement) {
            progressBarElement.style.width = `${Math.min(progress, 100)}%`;
        }
    }

    // 班級選擇
    function selectClass(element) {
        document.querySelectorAll('#classSelection .option-card').forEach(card => card.classList.remove('selected'));
        element.classList.add('selected');
        formData.class = element.dataset.value;
        document.getElementById('nextToGroup').disabled = false;
        
        const groupOptions = document.getElementById('groupOptions');
        groupOptions.innerHTML = ''; 
        formData.group = ''; 
        document.getElementById('nextToSelfEval').disabled = true;

        if (classGroups[formData.class]) {
            classGroups[formData.class].forEach((groupData) => {
                const groupCard = document.createElement('div');
                groupCard.className = 'option-card p-4 cursor-pointer';
                groupCard.dataset.value = groupData.group;
                groupCard.onclick = function() { selectGroup(this); };
                groupCard.innerHTML = `<div class="flex items-center"><span class="text-indigo-600 text-2xl mr-3">👥</span><span class="font-medium">${groupData.group}</span></div>`;
                groupOptions.appendChild(groupCard);
            });
        }
    }

    // 組別選擇
    function selectGroup(element) {
        document.querySelectorAll('#groupSelection .option-card').forEach(card => card.classList.remove('selected'));
        element.classList.add('selected');
        formData.group = element.dataset.value;
        document.getElementById('nextToSelfEval').disabled = false;
        
        const memberOptions = document.getElementById('memberOptions');
        memberOptions.innerHTML = ''; 
        formData.self = ''; 
        document.getElementById('nextToSelfTasks').disabled = true;

        const groupData = classGroups[formData.class]?.find(g => g.group === formData.group);
        if (groupData) {
            groupData.members.forEach(member => {
                const memberCard = document.createElement('div');
                memberCard.className = 'option-card p-4 cursor-pointer';
                memberCard.dataset.value = member;
                memberCard.onclick = function() { selectSelf(this); };
                memberCard.innerHTML = `<div class="flex items-center"><span class="text-indigo-600 text-2xl mr-3">👤</span><span class="font-medium">${member}</span></div>`;
                memberOptions.appendChild(memberCard);
            });
        }
    }

    // 選擇自己
    function selectSelf(element) {
        document.querySelectorAll('#selfSelection .option-card').forEach(card => card.classList.remove('selected'));
        element.classList.add('selected');
        formData.self = element.dataset.value;
        document.getElementById('nextToSelfTasks').disabled = false;
    }

    // 切換複選框 (通用)
    function toggleCheckbox(element, type) { 
        const checkbox = element.querySelector('input[type="checkbox"]');
        if (!checkbox) return;
        checkbox.checked = !checkbox.checked;
        element.classList.toggle('selected', checkbox.checked);
        
        if (type === 'selfTasks') {
            formData.selfTasks = Array.from(document.querySelectorAll('#selfTasks input[type="checkbox"]:checked')).map(cb => cb.value);
            document.getElementById('nextToSelfEffort').disabled = formData.selfTasks.length === 0;
        } else if (type === 'selfEffort') {
            formData.selfEffort = Array.from(document.querySelectorAll('#selfEffort input[type="checkbox"]:checked')).map(cb => cb.value);
            document.getElementById('nextToSelfRating').disabled = formData.selfEffort.length === 0;
        } else if (type === 'peerTasks') {
            const peerEval = formData.peerEvals.find(p => p.peer === currentEvaluatingPeerName);
            if (peerEval) {
                peerEval.tasks = Array.from(document.querySelectorAll('#peerTasks input[type="checkbox"]:checked')).map(cb => cb.value);
            }
            document.getElementById('nextToPeerRating').disabled = false; 
        }
    }
    
    function rebindCheckboxes() {
        document.querySelectorAll('#selfTasks .custom-checkbox').forEach(el => {
            el.onclick = function() { toggleCheckbox(this, 'selfTasks'); };
        });
        document.querySelectorAll('#selfEffort .custom-checkbox').forEach(el => {
            el.onclick = function() { toggleCheckbox(this, 'selfEffort'); };
        });
        document.querySelectorAll('#peerTaskCheckboxes .custom-checkbox').forEach(el => {
            el.onclick = function() { toggleCheckbox(this, 'peerTasks'); };
        });
    }
    
    // 選擇評分
function selectRating(element, inputIdPrefix) {
    console.log('[selectRating] Called. inputIdPrefix:', inputIdPrefix, 'Element value:', element.dataset.value); // 新增日誌
    const container = element.closest('.rating-container');
    if (!container) {
        console.error('[selectRating] Rating container not found.'); // 新增日誌
        return;
    }
    container.querySelectorAll('.rating-btn').forEach(btn => btn.classList.remove('selected'));
    element.classList.add('selected');
    const ratingValue = element.dataset.value;
    const ratingValueInput = document.getElementById(inputIdPrefix); // 這應該是 'selfRatingValue' 或 'peerRatingValue'

    if (ratingValueInput) {
        ratingValueInput.value = ratingValue;
    } else {
        console.error('[selectRating] Hidden input not found for ID:', inputIdPrefix); // 新增日誌
    }

    if (inputIdPrefix === 'selfRatingValue') { // 確保這裡的 ID 與 HTML onclick 傳入的一致
        formData.selfRating = ratingValue;
        console.log('[selectRating] formData.selfRating set to:', formData.selfRating); // 新增日誌
        console.log('[selectRating] Calling checkSelfRatingComplete...'); // 新增日誌
        checkSelfRatingComplete();
    } else if (inputIdPrefix === 'peerRatingValue') {
        const peerEval = formData.peerEvals.find(p => p.peer === currentEvaluatingPeerName);
        if (peerEval) {
            peerEval.rating = ratingValue;
            console.log('[selectRating] Peer rating set for', currentEvaluatingPeerName, 'to:', peerEval.rating); // 新增日誌
        }
        console.log('[selectRating] Calling checkPeerRatingComplete for peer...'); // 新增日誌
        checkPeerRatingComplete();
    }
}

    // 檢查自評評分是否完成
function checkSelfRatingComplete() {
    console.log('[checkSelfRatingComplete] Called.'); // 新增日誌
    const selfCommentElement = document.getElementById('selfComment');
    if (selfCommentElement) {
        formData.selfComment = selfCommentElement.value.trim();
    } else {
        console.error('[checkSelfRatingComplete] selfComment textarea not found.'); // 新增日誌
        formData.selfComment = ''; // 避免後續出錯
    }

    console.log('[checkSelfRatingComplete] formData.selfRating:', formData.selfRating); // 新增日誌
    console.log('[checkSelfRatingComplete] formData.selfComment:', formData.selfComment); // 新增日誌

    const nextButton = document.getElementById('nextToPeerEval');
    if (nextButton) {
        constisDisabled = !(formData.selfRating && formData.selfComment);
        nextButton.disabled = isDisabled;
        console.log('[checkSelfRatingComplete] Condition (formData.selfRating && formData.selfComment):', (formData.selfRating && formData.selfComment)); // 新增日誌
        console.log('[checkSelfRatingComplete] nextToPeerEval button disabled set to:', isDisabled); // 新增日誌
    } else {
        console.error('[checkSelfRatingComplete] nextToPeerEval button not found.'); // 新增日誌
    }
}

    // 檢查互評評分是否完成
    function checkPeerRatingComplete() {
        const peerEval = formData.peerEvals.find(p => p.peer === currentEvaluatingPeerName);
        if (peerEval) {
            peerEval.comment = document.getElementById('peerComment').value.trim();
            document.getElementById('nextPeerEval').disabled = !(peerEval.rating && peerEval.comment);
        } else {
            document.getElementById('nextPeerEval').disabled = true;
        }
    }

    // 初始化互評相關變數
    function initializePeerEvaluation() {
        const groupData = classGroups[formData.class]?.find(g => g.group === formData.group);
        if (!groupData) return;
        peersToEvaluate = groupData.members.filter(member => member !== formData.self);
        formData.peerEvals = []; 
        updatePeerOptionsDisplay(); 
        updatePeerEvalCountDisplay();
    }
    
    function updatePeerOptionsDisplay() {
        const peerOptionsContainer = document.getElementById('peerOptions');
        if(!peerOptionsContainer) return;
        peerOptionsContainer.innerHTML = ''; 

        peersToEvaluate.forEach(peerName => {
            const peerEvalData = formData.peerEvals.find(p => p.peer === peerName);
            const isEvaluated = peerEvalData && peerEvalData.rating && peerEvalData.comment;

            const peerCard = document.createElement('div');
            peerCard.className = `option-card p-4 cursor-pointer ${isEvaluated ? 'evaluated' : ''} ${currentEvaluatingPeerName === peerName && !isEvaluated ? 'selected' : ''}`;
            peerCard.dataset.value = peerName;
            peerCard.onclick = function() { selectPeerToEvaluate(this); };
            
            let statusText = isEvaluated ? '<span class="text-green-500 text-sm ml-2">（已評完）</span>' : '';
            
            peerCard.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                       <span class="text-indigo-600 text-2xl mr-3">👤</span>
                       <span class="font-medium">${peerName}</span>
                    </div>
                    ${statusText}
                </div>`;
            peerOptionsContainer.appendChild(peerCard);
        });

        const nextButton = document.getElementById('nextToPeerTasks');
        if (!nextButton) return;

        const allPeersEvaluated = formData.peerEvals.length === peersToEvaluate.length && peersToEvaluate.length > 0 && formData.peerEvals.every(p => p.rating && p.comment);
        if (allPeersEvaluated) {
            nextButton.textContent = "完成互評，查看摘要"; 
            nextButton.disabled = false; 
            nextButton.onclick = function() { 
                prepareSummary();
                showPage('confirmation');
            };
        } else if (currentEvaluatingPeerName) {
            const currentPeerData = formData.peerEvals.find(p => p.peer === currentEvaluatingPeerName);
            nextButton.textContent = (currentPeerData && currentPeerData.rating && currentPeerData.comment) ? "查看/修改此組員評價" : "開始評價此組員";
            nextButton.disabled = false;
            nextButton.onclick = function() { loadPeerTasksPageFor(currentEvaluatingPeerName); };
        } else {
            nextButton.textContent = "選擇組員後進行下一步";
            nextButton.disabled = true; 
            nextButton.onclick = function() { if(currentEvaluatingPeerName) loadPeerTasksPageFor(currentEvaluatingPeerName); };
        }
    }

    function selectPeerToEvaluate(element) {
        currentEvaluatingPeerName = element.dataset.value; 
        updatePeerOptionsDisplay(); // Just re-run to update selection and button state
    }
    
    function loadPeerTasksPageFor(peerName) {
        if (!peerName) return;
        currentEvaluatingPeerName = peerName; 
        const currentPeerNameSpan = document.getElementById('currentPeerName');
        const currentPeerNameRatingSpan = document.getElementById('currentPeerNameRating');
        if (currentPeerNameSpan) currentPeerNameSpan.textContent = peerName;
        if (currentPeerNameRatingSpan) currentPeerNameRatingSpan.textContent = peerName;

        let peerEval = formData.peerEvals.find(p => p.peer === peerName);
        if (!peerEval) {
            peerEval = { peer: peerName, tasks: [], otherTask: '', rating: '', comment: '' };
            formData.peerEvals.push(peerEval);
        }
        resetAndFillPeerForm(peerEval);
        showPage('peerTasks');
    }

    function resetAndFillPeerForm(peerEvalData) {
        document.querySelectorAll('#peerTaskCheckboxes input[type="checkbox"]').forEach(cb => {
            cb.checked = false;
            cb.closest('.custom-checkbox')?.classList.remove('selected');
        });
        const otherPeerTaskInput = document.getElementById('otherPeerTask');
        if (otherPeerTaskInput) otherPeerTaskInput.value = '';
        
        document.querySelectorAll('#peerRating .rating-btn').forEach(btn => btn.classList.remove('selected'));
        const peerRatingValueInput = document.getElementById('peerRatingValue');
        if (peerRatingValueInput) peerRatingValueInput.value = '';
        const peerCommentTextarea = document.getElementById('peerComment');
        if (peerCommentTextarea) peerCommentTextarea.value = '';
        const nextPeerEvalButton = document.getElementById('nextPeerEval');
        if (nextPeerEvalButton) nextPeerEvalButton.disabled = true; 

        if (peerEvalData) {
            if (peerEvalData.tasks && peerEvalData.tasks.length > 0) {
                document.querySelectorAll('#peerTaskCheckboxes input[type="checkbox"]').forEach(cb => {
                    if (peerEvalData.tasks.includes(cb.value)) {
                        cb.checked = true;
                        cb.closest('.custom-checkbox')?.classList.add('selected');
                    }
                });
            }
            if (otherPeerTaskInput) otherPeerTaskInput.value = peerEvalData.otherTask || '';
            if (peerEvalData.rating) {
                document.querySelector(`#peerRating .rating-btn[data-value="${peerEvalData.rating}"]`)?.classList.add('selected');
                if (peerRatingValueInput) peerRatingValueInput.value = peerEvalData.rating;
            }
            if (peerCommentTextarea) peerCommentTextarea.value = peerEvalData.comment || '';
            checkPeerRatingComplete(); 
        }
        const nextToPeerRatingButton = document.getElementById('nextToPeerRating');
        if (nextToPeerRatingButton) nextToPeerRatingButton.disabled = false;
        rebindCheckboxes(); // Rebind after potential DOM changes for peer tasks
    }
    
    function updatePeerEvalCountDisplay() {
        const peerEvalCountSpan = document.getElementById('peerEvalCount');
        if (!peerEvalCountSpan) return;
        const evaluatedCount = formData.peerEvals.filter(p => p.rating && p.comment).length;
        const totalPeersToEvaluate = peersToEvaluate.length;
        peerEvalCountSpan.textContent = `${evaluatedCount}/${totalPeersToEvaluate}`;
    }

    function handleNextPeerOrConfirmation() {
        updatePeerEvalCountDisplay(); 
        updatePeerOptionsDisplay(); 

        const allPeersEvaluated = formData.peerEvals.length === peersToEvaluate.length && peersToEvaluate.length > 0 && formData.peerEvals.every(p => p.rating && p.comment);

        if (allPeersEvaluated) {
            prepareSummary();
            showPage('confirmation');
        } else {
            let nextPeerToEvaluate = peersToEvaluate.find(pName => !formData.peerEvals.find(ev => ev.peer === pName && ev.rating && ev.comment));
            currentEvaluatingPeerName = nextPeerToEvaluate || ''; // Go to selection if no specific next one or clear
            showPage('peerSelection'); 
        }
    }

    // 準備摘要頁面
    function prepareSummary() {
        document.getElementById('summaryClass').textContent = formData.class + '班';
        document.getElementById('summaryGroup').textContent = formData.group;
        document.getElementById('summarySelf').textContent = formData.self;
        document.getElementById('summarySelfTasks').textContent = formData.selfTasks.join(', ') || '無';
        document.getElementById('summaryOtherSelfTask').textContent = formData.otherSelfTask || '無';
        document.getElementById('summarySelfEffort').textContent = formData.selfEffort.join(', ') || '無';
        document.getElementById('summaryOtherSelfEffort').textContent = formData.otherSelfEffort || '無';
        document.getElementById('summarySelfRating').textContent = formData.selfRating;
        document.getElementById('summarySelfComment').textContent = formData.selfComment;
        
        const peerEvalSummaryContainer = document.getElementById('peerEvalSummary');
        peerEvalSummaryContainer.innerHTML = '';
        
        formData.peerEvals.forEach((peerEval) => {
            if (peerEval.peer && peerEval.rating && peerEval.comment) {
                const peerSummary = document.createElement('div');
                peerSummary.className = 'bg-gray-50 p-4 rounded-lg mb-4';
                const peerIndexForDisplay = peersToEvaluate.indexOf(peerEval.peer) + 1;
                peerSummary.innerHTML = `
                    <h4 class="font-medium text-indigo-600 mb-2">互評 ${peerIndexForDisplay > 0 ? peerIndexForDisplay : '特定'} : ${peerEval.peer}</h4>
                    <p><span class="font-medium">觀察到的工作任務：</span>${peerEval.tasks ? peerEval.tasks.join(', ') : '未記錄'}</p>
                    <p class="mt-1"><span class="font-medium">其他觀察到的工作任務：</span>${peerEval.otherTask || '無'}</p>
                    <p class="mt-1"><span class="font-medium">評分：</span>${peerEval.rating}</p>
                    <p class="mt-1"><span class="font-medium">評價理由：</span></p>
                    <p class="text-gray-600 mt-1">${peerEval.comment}</p>`;
                peerEvalSummaryContainer.appendChild(peerSummary);
            }
        });
    }

    // 返回開始頁面 (重置表單)
    function returnToStart() {
        formData = {
            class: '', group: '', self: '', selfTasks: [], otherSelfTask: '',
            selfEffort: [], otherSelfEffort: '', selfRating: '', selfComment: '',
            peerEvals: [], timestamp: ''
        };
        peersToEvaluate = []; currentEvaluatingPeerName = ''; formSubmitted = false;

        document.querySelectorAll('input[type="text"], textarea').forEach(input => input.value = '');
        document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
            cb.checked = false;
            cb.closest('.custom-checkbox')?.classList.remove('selected');
        });
        document.querySelectorAll('.option-card.selected').forEach(card => card.classList.remove('selected'));
        document.querySelectorAll('.rating-btn.selected').forEach(btn => btn.classList.remove('selected'));
        
        ['nextToGroup', 'nextToSelfEval', 'nextToSelfTasks', 'nextToSelfEffort', 
         'nextToSelfRating', 'nextToPeerEval', 'nextToPeerTasks', 'nextPeerEval']
        .forEach(id => {
            const button = document.getElementById(id);
            if (button) button.disabled = true;
        });
        showPage('classSelection');
    }

    // 提交表單到Google試算表
    async function submitToGoogleSheet() {
        if (formSubmitted) {
            alert('表單已提交，請勿重複提交。');
            return;
        }
        const loadingOverlay = document.getElementById('loadingOverlay');
        if (loadingOverlay) loadingOverlay.classList.remove('hidden');
        
        formData.timestamp = new Date().toISOString();
        
        const scriptURL = 'https://script.google.com/macros/s/AKfycbxY158J77F4HeduN_lHKyTllJU9ySIAWU_cBscsumrOe52fC7pEno9_KghPesqjhGM8/exec'; // !!! 請務必替換成您自己的 !!!

        if (scriptURL === 'https://script.google.com/macros/s/AKfycbxY158J77F4HeduN_lHKyTllJU9ySIAWU_cBscsumrOe52fC7pEno9_KghPesqjhGM8/exec' || scriptURL.includes('AKfycbxY158J77F4HeduN_lHKyTllJU9ySIAWU_cBscsumrOe52fC7pEno9_KghPesqjhGM8') && scriptURL !== 'YOUR_REAL_URL_IF_TESTING') {
             if (loadingOverlay) loadingOverlay.classList.add('hidden');
             alert('錯誤：請先在HTML程式碼中設定您自己的Google Apps Script Web App URL (scriptURL變數)。');
             return;
        }

        try {
            const formattedData = formatDataForSubmission(formData);
            const response = await fetch(scriptURL, {
                method: 'POST',
                mode: 'no-cors', 
                headers: {
                     // 'Content-Type': 'application/json' // For 'no-cors', this header might be ignored or cause issues.
                                                            // Apps Script doPost by default can handle application/x-www-form-urlencoded if 'e.parameter' is used.
                                                            // For 'e.postData.contents' to work with JSON, the server (Apps Script) needs to handle it,
                                                            // and 'no-cors' can make this tricky.
                                                            // Let's try without explicitly setting Content-Type for 'no-cors' first if JSON parsing fails.
                                                            // Or, keep it and hope GAS is lenient with no-cors + application/json
                    'Content-Type': 'application/json', // Keeping for now based on previous attempts
                },
                body: JSON.stringify(formattedData), // <-- 修正：補回 body
            });
            
            // With 'no-cors', response.ok will be false, response.status will be 0.
            // We can't reliably check for success from the response here.
            // Assume success if no error is thrown by fetch itself, and check Google Sheet.
            if (loadingOverlay) loadingOverlay.classList.add('hidden');
            formSubmitted = true; // Optimistically set to true
            showPage('success');
            // alert('評價已嘗試提交！請檢查您的 Google 試算表確認資料是否已寫入。由於瀏覽器限制，無法直接確認提交狀態。');

        } catch (error) {
            console.error('提交錯誤:', error);
            if (loadingOverlay) loadingOverlay.classList.add('hidden');
            alert(`提交失敗，請檢查網路連線或稍後再試。\n錯誤詳情：${error.message}`);
        }
    }

    // 格式化資料以便提交
    function formatDataForSubmission(data) {
        const baseData = {
            timestamp: data.timestamp, class: data.class, group: data.group, self: data.self,
            selfTasks: data.selfTasks.join(', '), otherSelfTask: data.otherSelfTask,
            selfEffort: data.selfEffort.join(', '), otherSelfEffort: data.otherSelfEffort,
            selfRating: data.selfRating, selfComment: data.selfComment
        };
        peersToEvaluate.forEach((peerNameToEval, index) => {
            const evalData = data.peerEvals.find(p => p.peer === peerNameToEval);
            const i = index + 1; 
            if (evalData) {
                baseData[`peer${i}`] = evalData.peer;
                baseData[`peer${i}Tasks`] = evalData.tasks ? evalData.tasks.join(', ') : '';
                baseData[`peer${i}OtherTask`] = evalData.otherTask || '';
                baseData[`peer${i}Rating`] = evalData.rating;
                baseData[`peer${i}Comment`] = evalData.comment;
            } else {
                baseData[`peer${i}`] = peerNameToEval; 
                baseData[`peer${i}Tasks`] = ''; baseData[`peer${i}OtherTask`] = '';
                baseData[`peer${i}Rating`] = ''; baseData[`peer${i}Comment`] = '';
            }
        });
        return baseData;
    }

    // 截圖功能 (您的原始碼中沒有，但之前討論過，如果需要可以從之前的版本複製過來)
    // async function takeScreenshot() { ... }


    // 頁面載入時初始化
    document.addEventListener('DOMContentLoaded', function() {
        rebindCheckboxes(); // Bind all checkbox handlers initially
        showPage('classSelection'); // Initial page

        const selfCommentTextarea = document.getElementById('selfComment');
if (selfCommentTextarea) {
    selfCommentTextarea.addEventListener('input', function() { // 將 checkSelfRatingComplete 直接包裝以增加日誌
        console.log('[selfComment input event] Input detected, calling checkSelfRatingComplete...'); // 新增日誌
        checkSelfRatingComplete();
    });
} else {
    console.error('[DOMContentLoaded] selfComment textarea not found for event listener setup.'); // 新增日誌
}

        document.getElementById('nextToGroup').addEventListener('click', function() { if (formData.class) showPage('groupSelection'); });
        document.getElementById('nextToSelfEval').addEventListener('click', function() { if (formData.group) showPage('selfSelection'); });
        document.getElementById('nextToSelfTasks').addEventListener('click', function() { 
            if (formData.self) {
                ['selfTasks', 'selfEffort'].forEach(type => {
                    document.querySelectorAll(`#${type} input[type="checkbox"]`).forEach(cb => {
                        cb.checked = false;
                        cb.closest('.custom-checkbox')?.classList.remove('selected');
                    });
                    formData[type] = [];
                });
                document.getElementById('otherSelfTask').value = '';
                document.getElementById('otherSelfEffort').value = '';
                document.getElementById('nextToSelfEffort').disabled = true;
                document.getElementById('nextToSelfRating').disabled = true;
                showPage('selfTasks');
            }
        });
        document.getElementById('nextToSelfEffort').addEventListener('click', function() {
            formData.otherSelfTask = document.getElementById('otherSelfTask').value.trim();
            if (formData.selfTasks.length > 0) showPage('selfEffort');
            else alert('請至少選擇一項您負責的工作任務。');
        });
        document.getElementById('nextToSelfRating').addEventListener('click', function() {
            formData.otherSelfEffort = document.getElementById('otherSelfEffort').value.trim();
            if (formData.selfEffort.length > 0) {
                document.querySelectorAll('#selfRating .rating-btn.selected').forEach(btn => btn.classList.remove('selected'));
                document.getElementById('selfRatingValue').value = ''; formData.selfRating = '';
                document.getElementById('selfComment').value = ''; formData.selfComment = '';
                document.getElementById('nextToPeerEval').disabled = true;
                showPage('selfRating');
            } else alert('請至少選擇一項描述您的投入程度。');
        });
        document.getElementById('selfComment').addEventListener('input', checkSelfRatingComplete);
        document.getElementById('nextToPeerEval').addEventListener('click', function() {
            if (formData.selfRating && formData.selfComment) {
                initializePeerEvaluation(); 
                showPage('peerSelection');
            } else alert('請完成自評分數和自我評價。');
        });
        document.getElementById('nextToPeerTasks').addEventListener('click', function() {
            const allPeersEvaluated = formData.peerEvals.length === peersToEvaluate.length && peersToEvaluate.length > 0 && formData.peerEvals.every(p => p.rating && p.comment);
            if (currentEvaluatingPeerName && !allPeersEvaluated) { 
                loadPeerTasksPageFor(currentEvaluatingPeerName);
            } else if (allPeersEvaluated) {
                prepareSummary();
                showPage('confirmation');
            } else {
                alert('請先選擇一位您要評價的組員。');
            }
        });
        document.getElementById('nextToPeerRating').addEventListener('click', function() {
            const peerEval = formData.peerEvals.find(p => p.peer === currentEvaluatingPeerName);
            if (peerEval) peerEval.otherTask = document.getElementById('otherPeerTask').value.trim();
            if(peerEval && !peerEval.rating) { 
                document.querySelectorAll('#peerRating .rating-btn.selected').forEach(btn => btn.classList.remove('selected'));
                document.getElementById('peerRatingValue').value = '';
            }
            if(peerEval && !peerEval.comment) document.getElementById('peerComment').value = '';
            document.getElementById('nextPeerEval').disabled = !(peerEval && peerEval.rating && peerEval.comment);
            showPage('peerRating');
        });
        document.getElementById('peerComment').addEventListener('input', checkPeerRatingComplete);
        document.getElementById('nextPeerEval').addEventListener('click', function() {
            const peerEval = formData.peerEvals.find(p => p.peer === currentEvaluatingPeerName);
            if (peerEval && peerEval.rating && peerEval.comment) handleNextPeerOrConfirmation();
            else alert('請為這位組員選擇評分並填寫評價理由。');
        });
        document.getElementById('submitForm').addEventListener('click', function() { submitToGoogleSheet(); });
        
        // 如果您的 HTML 裡有 takeScreenshot 按鈕，記得加上監聽器
        // const takeScreenshotButton = document.getElementById('takeScreenshot');
        // if (takeScreenshotButton) {
        //     takeScreenshotButton.addEventListener('click', takeScreenshot);
        // }
    });
</script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'945cc1cbe27c8448',t:'MTc0ODI1NzEwMy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
